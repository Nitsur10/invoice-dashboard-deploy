# QA Agent

## ROLE
qa

## A11Y
axe score ≥ 95 on changed routes, keyboard nav, focus order, contrast ≥ 4.5:1

## VISUAL
minimal screenshot diffs if applicable. No layout regressions >4px on key components

## DETAILED BEHAVIOR

### Accessibility Testing

#### Automated Accessibility Checks
```typescript
// tests/a11y/axe-checks.test.ts
import { test, expect } from '@playwright/test'
import AxeBuilder from '@axe-core/playwright'

test.describe('Accessibility - Changed Routes', () => {
  test('dashboard page meets WCAG AA standards', async ({ page }) => {
    await page.goto('/dashboard')

    const accessibilityScanResults = await new AxeBuilder({ page })
      .include('.stats-cards') // Focus on changed components
      .analyze()

    expect(accessibilityScanResults.violations).toEqual([])

    // Calculate score: (total - violations) / total * 100
    const score = calculateAxeScore(accessibilityScanResults)
    expect(score).toBeGreaterThanOrEqual(95)
  })
})
```

#### Manual Accessibility Checks
**Keyboard Navigation:**
```typescript
test('keyboard navigation works for trend displays', async ({ page }) => {
  await page.goto('/dashboard')

  // Tab through interactive elements
  await page.keyboard.press('Tab')
  await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'revenue-card')

  // Verify focus indicators are visible
  await expect(page.locator(':focus')).toHaveCSS('outline-width', /.+/)
})
```

**Focus Order:**
- Verify logical tab sequence through modified components
- Ensure focus indicators are visible and meet contrast requirements
- Test screen reader announcements for dynamic content

**Color Contrast:**
```typescript
test('trend indicators meet contrast requirements', async ({ page }) => {
  await page.goto('/dashboard')

  const trendElement = page.locator('[data-testid="revenue-trend"]')
  const styles = await trendElement.evaluate(el => {
    const computed = getComputedStyle(el)
    return {
      color: computed.color,
      backgroundColor: computed.backgroundColor
    }
  })

  const contrastRatio = calculateContrastRatio(styles.color, styles.backgroundColor)
  expect(contrastRatio).toBeGreaterThanOrEqual(4.5)
})
```

### Visual Regression Testing

#### Screenshot Comparison
```typescript
// tests/visual/regression.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Visual Regression - Modified Components', () => {
  test('stats cards layout unchanged', async ({ page }) => {
    await page.goto('/dashboard')

    // Wait for data to load
    await page.waitForLoadState('networkidle')

    // Screenshot specific components that changed
    const statsSection = page.locator('[data-testid="stats-section"]')
    await expect(statsSection).toHaveScreenshot('stats-cards-after-trends.png', {
      threshold: 0.2, // Allow 20% pixel difference
      maxDiffPixels: 100 // Maximum 100 pixels can differ
    })
  })

  test('mobile layout regression check', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 })
    await page.goto('/dashboard')

    await expect(page.locator('[data-testid="stats-section"]')).toHaveScreenshot('mobile-stats.png')
  })
})
```

#### Layout Measurement
```typescript
test('no layout shifts >4px in key components', async ({ page }) => {
  await page.goto('/dashboard')

  // Measure initial positions
  const initialBounds = await page.locator('[data-testid="invoice-table"]').boundingBox()

  // Trigger any dynamic content loading
  await page.locator('[data-testid="refresh-stats"]').click()
  await page.waitForLoadState('networkidle')

  // Measure final positions
  const finalBounds = await page.locator('[data-testid="invoice-table"]').boundingBox()

  // Verify no significant layout shift
  const deltaY = Math.abs(finalBounds.y - initialBounds.y)
  expect(deltaY).toBeLessThanOrEqual(4)
})
```

### Component-Level QA

#### Interactive Element Testing
```typescript
test('trend display interactive elements work correctly', async ({ page }) => {
  await page.goto('/dashboard')

  // Test hover states
  await page.locator('[data-testid="revenue-trend"]').hover()
  await expect(page.locator('[data-testid="trend-tooltip"]')).toBeVisible()

  // Test click interactions if applicable
  if (await page.locator('[data-testid="revenue-card"]').getAttribute('role') === 'button') {
    await page.locator('[data-testid="revenue-card"]').click()
    // Verify expected behavior
  }
})
```

#### Data Loading States
```typescript
test('loading states accessible and visually consistent', async ({ page }) => {
  // Slow network to catch loading states
  await page.route('/api/stats', route =>
    route.fulfill({ json: mockData, delay: 1000 })
  )

  await page.goto('/dashboard')

  // Verify loading state accessibility
  const loadingElement = page.locator('[data-testid="stats-loading"]')
  await expect(loadingElement).toHaveAttribute('aria-label', /.+/)
  await expect(loadingElement).toHaveAttribute('role', 'status')
})
```

### Cross-Browser Testing

#### Browser-Specific Checks
```typescript
// Run across multiple browsers for critical changes
test.describe('Cross-browser compatibility', () => {
  ['chromium', 'firefox', 'webkit'].forEach(browserName => {
    test(`trend display works in ${browserName}`, async ({ browser }) => {
      const context = await browser.newContext()
      const page = await context.newPage()

      await page.goto('/dashboard')
      await expect(page.locator('[data-testid="revenue-trend"]')).toBeVisible()

      await context.close()
    })
  })
})
```

### Performance Impact Testing

#### Core Web Vitals
```typescript
test('no performance regression from new features', async ({ page }) => {
  const metricsPromise = page.evaluate(() => {
    return new Promise(resolve => {
      new PerformanceObserver(list => {
        const entries = list.getEntries()
        resolve(entries.map(entry => ({
          name: entry.name,
          value: entry.value || entry.duration
        })))
      }).observe({ entryTypes: ['navigation', 'paint', 'layout-shift'] })
    })
  })

  await page.goto('/dashboard')
  const metrics = await metricsPromise

  // Verify no significant CLS from new trend displays
  const cls = metrics.find(m => m.name === 'layout-shift')?.value || 0
  expect(cls).toBeLessThan(0.1)
})
```

## EXECUTION PROTOCOL

### QA Checklist
1. **Run accessibility audit** on all modified routes
2. **Execute keyboard navigation tests** for new interactive elements
3. **Verify color contrast compliance** for new UI elements
4. **Capture visual regression screenshots** of modified components
5. **Measure layout stability** during dynamic content loading
6. **Test cross-browser compatibility** for critical functionality
7. **Validate performance impact** of new features

### QA Report Format
```markdown
## QA Results Summary

### Accessibility ✅/❌
- Axe score: 97/100 (target: ≥95) ✅
- Keyboard navigation: All interactive elements accessible ✅
- Focus indicators: Visible and high contrast ✅
- Color contrast: All elements ≥4.5:1 ✅

### Visual Testing ✅/❌
- Screenshot diffs: <20% change, within threshold ✅
- Layout regression: <4px shift on key components ✅
- Mobile compatibility: No breaking changes ✅

### Cross-Browser ✅/❌
- Chrome: All tests pass ✅
- Firefox: All tests pass ✅
- Safari: All tests pass ✅

### Performance Impact ✅/❌
- Core Web Vitals: No regression ✅
- Bundle size: +2KB (within budget) ✅
- Runtime performance: No significant impact ✅

## Issues Found
- None

## Recommendations
- Consider adding aria-describedby to trend indicators for screen readers
- Monitor real user metrics post-deployment
```

### Remediation Actions
If QA checks fail:
1. **Document specific failures** with screenshots and steps to reproduce
2. **Provide actionable remediation steps** for each issue
3. **Re-run QA checks** after fixes applied
4. **Block progression to next phase** until all issues resolved